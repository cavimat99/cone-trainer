<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cone Refelx</title>

<!-- PWA / iPhone full screen -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0a0f16" />
<link rel="manifest" href="manifest.webmanifest" />

<style>
  :root{
    --bg:#0a0f16; --panel:#0f1622; --text:#e8eef6;
    --muted:#9db0c8; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --radius:16px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html, body{height:100%; overflow:hidden;}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"SF Pro",Inter,Roboto,Arial,sans-serif;}

  .app{height:100dvh; display:grid; grid-template-rows:1fr auto;}

  /* ============ SETTINGS ============ */
  .settingsView{
    padding:max(12px, env(safe-area-inset-top)) 14px 10px;
    display:grid; align-content:start; gap:14px; background:var(--panel); border-bottom:1px solid #1b2433;
  }
  .heading{font-size:18px; color:#cfe1ff; font-weight:700; letter-spacing:.01em}
  .sub{font-size:13px; color:var(--muted)}

  .row{display:grid; gap:10px}
  .rowGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:390px){ .rowGrid{grid-template-columns:1fr 1fr} }
  .label{font-size:13px; color:#c4d2e6}

  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    padding:10px 12px; border-radius:12px; border:1px solid #273449; background:#0e1420; color:#d8e6fb;
    font-size:15px; font-weight:700; cursor:pointer; touch-action:manipulation; user-select:none;
  }
  .chip.small{font-size:13px; padding:8px 10px}
  .chip.selected{background:var(--accent); border-color:transparent; color:#fff; box-shadow:0 6px 18px rgba(59,130,246,.25)}
  .hidden{display:none}

  /* anteprima palette */
  .dots{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .dot{width:18px; height:18px; border-radius:50%; border:1px solid rgba(0,0,0,.35)}

  /* Start in basso */
  .startBar{
    position:relative;
    padding:10px 12px calc(12px + env(safe-area-inset-bottom));
    background:linear-gradient(180deg, rgba(10,16,24,0), rgba(10,16,24,.65));
    display:flex; gap:10px; align-items:center; justify-content:center;
  }
  .btn{
    flex:1; max-width:420px;
    padding:16px 18px; border:none; border-radius:14px; font-size:18px; font-weight:900;
    color:#fff; background:var(--accent); cursor:pointer; touch-action:manipulation;
    box-shadow:0 10px 28px rgba(59,130,246,.35);
  }

  /* ============ RUN (full) ============ */
  .runView{position:relative; background:#000; display:none}
  .runView.on{display:block}
  .stage{position:absolute; inset:0; display:grid; place-items:center; transition:background-color .18s ease}
  .phaseBar{position:absolute; top:calc(8px + env(safe-area-inset-top)); left:0; right:0; display:flex; justify-content:center; padding:0 10px; pointer-events:none}
  .phaseText{
    pointer-events:auto; font-size:clamp(13px,4.2vw,18px); text-transform:uppercase; line-height:1.2;
    color:#dbe9ff; background:rgba(10,16,24,.6); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    max-width:96vw; word-break:break-word;
  }
  .setTag{position:absolute; left:10px; top:calc(8px + env(safe-area-inset-top)); font-size:12px; color:#b0c4de; background:rgba(10,16,24,.55); padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.06)}

  .center{text-align:center; padding:24px}
  .big{font-weight:900; line-height:1; margin:.05em 0; font-size:clamp(72px,28dvh,240px); color:#fff; letter-spacing:.02em;
    text-shadow:0 0 8px rgba(0,0,0,.65), 0 0 24px rgba(0,0,0,.45), -2px -2px 0 rgba(0,0,0,.85), 2px -2px 0 rgba(0,0,0,.85), -2px 2px 0 rgba(0,0,0,.85), 2px 2px 0 rgba(0,0,0,.85)}
  .big.word{font-size:clamp(36px,12dvh,96px); line-height:1.05; max-width:96vw; word-break:break-word; padding:0 2vw}
  .timer{font-size:clamp(14px,3.5vw,22px); color:#e9f3ff; background:rgba(10,16,24,.45); padding:.4em .7em; border-radius:12px; border:1px solid rgba(255,255,255,.06); display:inline-block}
  .flash{position:absolute; inset:0; pointer-events:none; box-shadow:0 0 0 0 rgba(255,255,255,0)}
  .flash.on{animation:edge 240ms ease-out}
  @keyframes edge{0%{box-shadow:inset 0 0 0 6px rgba(255,255,255,.85),0 0 20px rgba(255,255,255,.25)}100%{box-shadow:inset 0 0 0 0 rgba(255,255,255,0),0 0 0 rgba(255,255,255,0)}}

  .runBar{
    position:fixed; left:0; right:0; bottom:0; z-index:5;
    padding:max(8px, env(safe-area-inset-bottom)) 10px calc(12px + env(safe-area-inset-bottom));
    display:flex; gap:10px; justify-content:center; align-items:center;
    background:linear-gradient(180deg, rgba(10,16,24,0), rgba(10,16,24,.65));
  }
  .bb{flex:1; max-width:280px; padding:14px 16px; border:none; border-radius:14px; font-size:18px; font-weight:800; color:#fff; cursor:pointer; touch-action:manipulation}
  .bb.primary{background:var(--accent)} .bb.danger{background:var(--danger)}

  /* Modal colori */
  .modal{position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,.5); z-index:20}
  .modal.on{display:flex}
  .sheet{width:100%; max-width:520px; background:#0f1622; border-radius:16px 16px 0 0; border:1px solid #1b2433; padding:14px 14px max(14px, calc(14px + env(safe-area-inset-bottom)))}
  .sheet h3{margin:0 0 10px; font-size:16px; color:#cfe1ff}
  .colorsGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .colorItem{display:flex; align-items:center; gap:10px; background:#0e1420; border:1px solid #273449; padding:8px; border-radius:12px}
  .colorItem label{font-size:13px; color:#c4d2e6; width:70px}
  .colorItem input[type="color"]{flex:1; height:44px; padding:0; border:none; background:transparent}
  .modalBtns{display:flex; gap:10px; margin-top:12px}
  .btnGhost{flex:1; padding:12px 14px; border-radius:12px; border:1px solid #2a374b; background:#0e1420; color:#e8eef6; font-weight:700}
  .btnPrim{flex:1; padding:12px 14px; border-radius:12px; border:none; background:var(--accent); color:#fff; font-weight:900}

  .sr{position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px)}

  /* --- Brand hero --- */
.brand{
  padding-top: max(6px, env(safe-area-inset-top));
  margin: -4px 0 8px;
}
.brandTitle{
  margin: 0;
  font-weight: 1000;
  font-size: clamp(28px, 8vw, 40px);
  line-height: 1.05;
  letter-spacing: .02em;
  color: #eaf2ff;                     /* "CONE" in bianco */
  text-shadow: 0 2px 24px rgba(59,130,246,.22);
}
.brandTitle .accent{
  background: linear-gradient(90deg,#22d3ee 0%, #3b82f6 55%, #a855f7 100%);
  -webkit-background-clip: text; background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 14px rgba(59,130,246,.35));
}
.brandSub{
  margin-top: 6px;
  font-size: 12px;
  color: #9db0c8;
  letter-spacing: .02em;
}

  
</style>
</head>
<body>
  <div class="app">

    <!-- SETTINGS -->
    <section id="settings" class="settingsView">
      <div class="brand" aria-label="CONE REFLEX">
  <h1 class="brandTitle">CONE <span class="accent">REFLEX</span></h1>
  <div class="brandSub">trainer di reazione Â· colori o numeri</div>
</div>
      <div>
        <div class="heading">Imposta allenamento</div>
        <div class="sub">Scegli parametri e premi Start.</div>
      </div>

      <div class="row">
        <div class="label">ModalitÃ </div>
        <div class="chips">
          <button class="chip selected" data-group="mode" data-value="color">Colori</button>
          <button class="chip" data-group="mode" data-value="number">Numeri</button>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Lavoro (s)</div>
          <div class="chips">
            <button class="chip" data-group="work" data-value="15">15</button>
            <button class="chip" data-group="work" data-value="20">20</button>
            <button class="chip selected" data-group="work" data-value="30">30</button>
            <button class="chip" data-group="work" data-value="45">45</button>
            <button class="chip" data-group="work" data-value="60">60</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Pausa (s)</div>
          <div class="chips">
            <button class="chip" data-group="rest" data-value="20">20</button>
            <button class="chip selected" data-group="rest" data-value="30">30</button>
            <button class="chip" data-group="rest" data-value="40">40</button>
            <button class="chip" data-group="rest" data-value="60">60</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Set</div>
          <div class="chips">
            <button class="chip" data-group="sets" data-value="3">3</button>
            <button class="chip selected" data-group="sets" data-value="5">5</button>
            <button class="chip" data-group="sets" data-value="8">8</button>
            <button class="chip" data-group="sets" data-value="10">10</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Intervallo segnali (s)</div>
          <div class="chips">
            <button class="chip" data-group="interval" data-value="3">3</button>
            <button class="chip selected" data-group="interval" data-value="5">5</button>
            <button class="chip" data-group="interval" data-value="8">8</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Countdown</div>
          <div class="chips">
            <button class="chip" data-group="countdown" data-value="0">Off</button>
            <button class="chip selected" data-group="countdown" data-value="3">3</button>
            <button class="chip" data-group="countdown" data-value="5">5</button>
          </div>
        </div>

        <div class="row" id="colorCountRow">
          <div class="label">Quanti coni</div>
          <div class="chips">
            <button class="chip" data-group="count" data-value="3">3</button>
            <button class="chip selected" data-group="count" data-value="5">5</button>
            <button class="chip" data-group="count" data-value="6">6</button>
          </div>
        </div>
        <div class="row hidden" id="numberCountRow">
          <div class="label">Quanti numeri</div>
          <div class="chips">
            <button class="chip" data-group="count" data-value="3">3</button>
            <button class="chip selected" data-group="count" data-value="5">5</button>
            <button class="chip" data-group="count" data-value="8">8</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">Opzioni suono</div>
        <div class="chips">
          <button class="chip small selected" data-group="beep" data-value="on">Suono ON</button>
          <button class="chip small" data-group="beep" data-value="off">Suono OFF</button>
        </div>
      </div>

      <!-- Palette personalizzabile -->
      <div class="row" id="paletteRow">
        <div class="label">Colori (modalitÃ  Colori)</div>
        <div class="chips">
          <div class="dots" id="colorPreview"></div>
          <button class="chip small" id="editColorsBtn">Modifica colori</button>
        </div>
      </div>
    </section>

    <!-- START -->
    <div class="startBar" id="startBar"><button id="startBtn" class="btn">START</button></div>

    <!-- RUN -->
    <section id="run" class="runView">
      <div class="stage" id="stage">
        <div class="flash" id="flash"></div>
        <div class="setTag" id="setInfo">Set â€”</div>
        <div class="phaseBar"><div class="phaseText" id="phaseLabel">PRONTO</div></div>
        <div class="center" id="hitArea">
          <div class="big" id="mainLabel">â€”</div>
          <div class="timer"><span id="timeLeft">0.0</span> s</div>
        </div>
      </div>
      <div class="runBar">
        <button id="bbToggle" class="bb primary">Pausa</button>
        <button id="bbStop" class="bb danger">Stop</button>
      </div>
    </section>

    <!-- MODAL COLORI -->
    <div id="colorModal" class="modal" aria-hidden="true">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="colTitle">
        <h3 id="colTitle">Modifica colori</h3>
        <div class="colorsGrid" id="colorsGrid"></div>
        <div class="modalBtns">
          <button class="btnGhost" id="cancelColors">Annulla</button>
          <button class="btnPrim" id="saveColors">Salva</button>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const qs = (sel,root=document)=>root.querySelector(sel);
  const qsa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  const els = {
    settings:$('settings'), startBar:$('startBar'), startBtn:$('startBtn'),
    colorCountRow:$('colorCountRow'), numberCountRow:$('numberCountRow'),
    paletteRow:$('paletteRow'), colorPreview:$('colorPreview'),
    colorModal:$('colorModal'), colorsGrid:$('colorsGrid'), saveColors:$('saveColors'), cancelColors:$('cancelColors'), editColorsBtn:$('editColorsBtn'),
    run:$('run'), stage:$('stage'), flash:$('flash'),
    setInfo:$('setInfo'), phaseLabel:$('phaseLabel'), mainLabel:$('mainLabel'), timeLeft:$('timeLeft'),
    bbToggle:$('bbToggle'), bbStop:$('bbStop'), hitArea:$('hitArea'),
  };

  const defaultPalette = ['#ff3b30','#ffcc00','#34c759','#007aff','#af52de','#ff9f0a','#32ade6','#ff2d55'];

  let app = {
    running:false, paused:false, phase:'idle',
    mode:'color', workMs:30000, restMs:30000, sets:5, intervalMs:5000, countdownMs:3000,
    count:5, colors:defaultPalette.slice(0,5), numbers:5,
    currentIdx:-1, setIndex:0, totalSets:5,
    startTs:0, phaseEndTs:0, nextSignalTs:0, pauseTs:0,
    rafId:null, audioCtx:null, lastSpoken:-1,
    beep:true
  };

  /* ======= UI: chips ======= */
  function selectInGroup(group, value){
    qsa(`.chip[data-group="${group}"]`).forEach(b=>b.classList.toggle('selected', b.dataset.value===String(value)));
  }
  function readSettings(){
    const mode = qs('.chip[data-group="mode"].selected').dataset.value;
    const work = Number(qs('.chip[data-group="work"].selected').dataset.value)*1000;
    const rest = Number(qs('.chip[data-group="rest"].selected').dataset.value)*1000;
    const sets = Number(qs('.chip[data-group="sets"].selected').dataset.value);
    const interval = Number(qs('.chip[data-group="interval"].selected').dataset.value)*1000;
    const countdown = Number(qs('.chip[data-group="countdown"].selected').dataset.value)*1000;
    const count = Number(qs('.chip[data-group="count"].selected').dataset.value);
    const beep = qs('.chip[data-group="beep"].selected').dataset.value==='on';
    return {mode, work, rest, sets, interval, countdown, count, beep};
  }
  function bindChips(){
    qsa('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const group = btn.dataset.group;
        const single = ['mode','work','rest','sets','interval','countdown','count','beep'];
        if(single.includes(group)){
          qsa(`.chip[data-group="${group}"]`).forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
        }
        // toggle blocchi per modalitÃ 
        if(group==='mode'){
          const mode = btn.dataset.value;
          els.colorCountRow.classList.toggle('hidden', mode!=='color');
          els.numberCountRow.classList.toggle('hidden', mode!=='number');
          els.paletteRow.classList.toggle('hidden', mode!=='color');
          updateColorPreview();
        }
        if(group==='count'){ // cambia numero coni/numeri
          const val = Number(btn.dataset.value);
          if(qs('.chip[data-group="mode"].selected').dataset.value==='color'){
            // adegua palette alla nuova quantitÃ 
            if(app.colors.length < val){
              const more = defaultPalette.slice(app.colors.length, val);
              app.colors = app.colors.concat(more);
            } else {
              app.colors = app.colors.slice(0, val);
            }
            updateColorPreview();
          }
        }
      }, {passive:true});
    });
  }

  /* ======= Palette / colori ======= */
  function updateColorPreview(){
    els.colorPreview.innerHTML='';
    const mode = qs('.chip[data-group="mode"].selected').dataset.value;
    if(mode!=='color'){ return; }
    const count = Number(qs('.chip[data-group="count"].selected').dataset.value);
    const palette = app.colors.slice(0,count);
    palette.forEach(c=>{
      const d=document.createElement('div'); d.className='dot'; d.style.background=c; els.colorPreview.appendChild(d);
    });
  }
  function openColorModal(){
    const count = Number(qs('.chip[data-group="count"].selected').dataset.value);
    const palette = app.colors.slice(0,count);
    els.colorsGrid.innerHTML='';
    for(let i=0;i<count;i++){
      const wrap=document.createElement('div'); wrap.className='colorItem';
      const lab=document.createElement('label'); lab.textContent='Colore '+(i+1);
      const inp=document.createElement('input'); inp.type='color'; inp.value=palette[i] || defaultPalette[i%defaultPalette.length]; inp.dataset.index=String(i);
      wrap.append(lab,inp); els.colorsGrid.appendChild(wrap);
    }
    els.colorModal.classList.add('on'); els.colorModal.setAttribute('aria-hidden','false');
  }
  function closeColorModal(){ els.colorModal.classList.remove('on'); els.colorModal.setAttribute('aria-hidden','true'); }
  els.editColorsBtn.addEventListener('click', openColorModal, {passive:true});
  els.cancelColors.addEventListener('click', closeColorModal, {passive:true});
  els.saveColors.addEventListener('click', ()=>{
    const inputs = qsa('input[type="color"]', els.colorsGrid);
    inputs.forEach(inp=>{
      const idx=Number(inp.dataset.index);
      app.colors[idx]=inp.value;
    });
    updateColorPreview();
    closeColorModal();
  }, {passive:true});
  els.colorModal.addEventListener('click', (e)=>{ if(e.target===els.colorModal) closeColorModal(); }, {passive:true});

  /* ======= Helpers ======= */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const fmtSec=(ms)=> (Math.ceil(ms/100)/10).toFixed(1);
  function setBg(c){ els.stage.style.background=c; }
  function setPhase(p){ app.phase=p; els.phaseLabel.textContent=p.toUpperCase(); }
  function setMainLabel(t){ const s=String(t); const isNum=/^#?\d+$/.test(s); els.mainLabel.classList.toggle('word', !isNum); els.mainLabel.textContent=s; }
  function setTimeLeft(ms){ els.timeLeft.textContent=fmtSec(ms); }
  function setSetInfo(){ els.setInfo.textContent = `Set ${app.setIndex+1} di ${app.totalSets}`; }
  function chooseNextIndex(pool){ if(pool<=1) return 0; let i; do{i=Math.floor(Math.random()*pool);}while(i===app.currentIdx); return (app.currentIdx=i); }
  function flashEdge(){ els.flash.classList.remove('on'); void els.flash.offsetWidth; els.flash.classList.add('on'); }

  // ðŸ‘‰ NEW: ridisegna subito lo stato corrente quando riprendi (numero/colore o testo fase)
  function renderCurrent(){
    if(app.phase === 'work'){
      if(app.mode === 'color'){
        if(app.currentIdx >= 0){
          const c = app.colors[app.currentIdx] || '#0a0f16';
          setBg(c);
          setMainLabel(`#${app.currentIdx+1}`);
        } else {
          setBg('#0a0f16');
          setMainLabel('VAI!');
        }
      } else { // number
        if(app.currentIdx >= 0){
          setBg('#0a0f16');
          setMainLabel(String(app.currentIdx+1));
        } else {
          setBg('#0a0f16');
          setMainLabel('VAI!');
        }
      }
    } else if(app.phase === 'rest'){
      setBg('#0a0f16');
      setMainLabel('RECUPERO');
    } else if(app.phase === 'countdown'){
      setBg('#0a0f16');
      setMainLabel('PARTENZA');
    } else if(app.phase === 'fine'){
      setBg('#0a0f16');
      setMainLabel('FINE âœ…');
    }
  }

  /* ======= Audio ======= */
  function beep(freq=880, dur=0.08, type='sine'){
    if(!app.beep) return;
    try{
      if(!app.audioCtx){ app.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      const ctx=app.audioCtx, o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
      o.start(); o.stop(ctx.currentTime + dur);
    }catch(e){}
  }

  /* ======= Flow ======= */
  function enterRun(){ els.settings.style.display='none'; els.startBar.style.display='none'; els.run.classList.add('on'); }
  function exitRun(){ els.run.classList.remove('on'); els.settings.style.display='grid'; els.startBar.style.display='flex'; }
  function resetUI(){ setPhase('pronto'); setMainLabel('â€”'); setTimeLeft(0); setBg('#0a0f16'); els.setInfo.textContent='Set â€”'; app.lastSpoken=-1; }

  function start(){
    if(app.running) return;
    const cfg = readSettings();
    // aggiorna stato
    app = {
      ...app,
      running:true, paused:false, phase:(cfg.countdown>0?'countdown':'work'),
      mode:cfg.mode, setIndex:0, totalSets:cfg.sets,
      workMs:cfg.work, restMs:cfg.rest, intervalMs:cfg.interval, countdownMs:cfg.countdown,
      count:cfg.count, numbers:cfg.count, beep:cfg.beep,
      colors: app.colors.slice(0, cfg.count),
      currentIdx:-1,
      startTs:performance.now()
    };
    app.phaseEndTs = app.startTs + (app.countdownMs>0?app.countdownMs:app.workMs);
    app.nextSignalTs = (app.countdownMs>0?0:app.startTs);

    setSetInfo(); setPhase(app.phase); setMainLabel(app.phase==='countdown'?'PARTENZA':'VAI!');
    setTimeLeft(app.countdownMs>0?app.countdownMs:app.workMs); setBg('#0a0f16');

    enterRun();
    beep(660,0.12,'triangle');
    app.rafId = requestAnimationFrame(loop);
  }

  function pause(){
    if(!app.running || app.paused) return;
    app.paused=true; app.pauseTs=performance.now();
    cancelAnimationFrame(app.rafId); setMainLabel('PAUSA'); els.bbToggle.textContent='Riprendi';
  }

  function resume(){
    if(!app.running || !app.paused) return;
    const now=performance.now(); const paused = now - app.pauseTs;
    app.phaseEndTs += paused; if(app.nextSignalTs) app.nextSignalTs += paused;
    app.paused=false; els.bbToggle.textContent='Pausa';

    // ðŸ‘‰ mostra SUBITO il contenuto (numero/colore o testo fase)
    renderCurrent();

    app.rafId = requestAnimationFrame(loop);
  }

  function stop(){
    app.running=false; app.paused=false; cancelAnimationFrame(app.rafId);
    resetUI(); exitRun();
  }

  function nextPhase(){
    const now=performance.now();
    if(app.phase==='countdown'){
      setPhase('work'); setMainLabel('VAI!');
      app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square'); return;
    }
    if(app.phase==='work'){
      if(app.restMs>0){
        setPhase('rest'); setMainLabel('RECUPERO'); setBg('#0a0f16');
        app.startTs=now; app.phaseEndTs=now+app.restMs; app.nextSignalTs=0; beep(520,0.12,'sine');
      } else {
        if(app.setIndex+1>=app.totalSets) return finish();
        app.setIndex++; setSetInfo(); setPhase('work'); setMainLabel('VAI!');
        app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square');
      }
      return;
    }
    if(app.phase==='rest'){
      if(app.setIndex+1>=app.totalSets) return finish();
      app.setIndex++; setSetInfo(); setPhase('work'); setMainLabel('VAI!');
      app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square');
    }
  }

  function finish(){
    setPhase('fine'); setMainLabel('FINE âœ…'); setBg('#0a0f16'); setTimeLeft(0);
    beep(440,0.1,'sine'); setTimeout(()=>beep(660,0.1,'sine'),120); setTimeout(()=>beep(880,0.1,'sine'),240);
    app.running=false; cancelAnimationFrame(app.rafId);
    setTimeout(stop, 700);
  }

  function loop(){
    if(!app.running) return;
    const now=performance.now();
    if(app.paused){ app.rafId = requestAnimationFrame(loop); return; }

    const msLeft=Math.max(0, app.phaseEndTs-now);
    setTimeLeft(msLeft);

    if(app.phase==='work' && now>=app.nextSignalTs){
      if(app.mode==='color'){
        const idx=chooseNextIndex(app.colors.length);
        const c=app.colors[idx]; setBg(c); setMainLabel(`#${idx+1}`); 
      } else {
        const idx=chooseNextIndex(app.numbers);
        const shown=idx+1; setBg('#0a0f16'); setMainLabel(String(shown));
      }
      flashEdge();
      beep(1200,0.05,'square'); setTimeout(()=>beep(900,0.05,'square'),60);
      app.nextSignalTs = now + app.intervalMs;
    }

    if(msLeft<=0) nextPhase();
    app.rafId = requestAnimationFrame(loop);
  }

  /* ======= Events ======= */
  bindChips();
  // sincronizza righe iniziali
  (function initRows(){
    const modeSel = qs('.chip[data-group="mode"].selected').dataset.value;
    els.colorCountRow.classList.toggle('hidden', modeSel!=='color');
    els.numberCountRow.classList.toggle('hidden', modeSel!=='number');
    els.paletteRow.classList.toggle('hidden', modeSel!=='color');
    updateColorPreview();
  })();

  // Start
  els.startBtn.addEventListener('click', start, {passive:true});
  // Bottom bar
  els.bbToggle.addEventListener('click', ()=>{ if(!app.running) return; if(app.paused) resume(); else pause(); }, {passive:true});
  // Stop immediato
  els.bbStop.addEventListener('click', ()=>{ if(app.running) stop(); }, {passive:true});
  // Tap centro = pausa/riprendi
  els.hitArea.addEventListener('click', ()=>{ if(!app.running) return; if(app.paused) resume(); else pause(); }, {passive:true});

})();
</script>

<!-- SW register: aggiorna anche sw.js a VERSION 'v6' -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js?v=6').catch(()=>{});
  });
}
</script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // importante cambiare la query per forzare il download del nuovo sw.js
    navigator.serviceWorker.register('./sw.js?v=killswitch-1').catch(()=>{});
  });
}
</script>
</body>
</html>






