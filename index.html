<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cone Trainer — iPhone UX</title>

<!-- PWA / iPhone full screen -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0a0f16" />
<link rel="manifest" href="manifest.webmanifest" />

<style>
  :root{
    --bg:#0a0f16; --panel:#0f1622; --text:#e8eef6;
    --muted:#9db0c8; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --radius:16px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html, body{height:100%; overflow:hidden;}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: system-ui, -apple-system, "SF Pro", Inter, Roboto, Arial, sans-serif;
  }

  /* App = viewport intero: area contenuti + barra in basso */
  .app{
    height:100dvh; display:grid; grid-template-rows: 1fr auto;
  }

  /* ============ SETTINGS VIEW (senza scroll) ============ */
  .settingsView{
    padding: max(12px, env(safe-area-inset-top)) 14px 10px;
    display:grid; align-content:start; gap:14px; background:var(--panel);
    border-bottom:1px solid #1b2433;
  }
  .heading{
    font-size:18px; color:#cfe1ff; font-weight:700; letter-spacing:.01em;
  }
  .sub{font-size:13px; color:var(--muted)}

  .row{display:grid; gap:10px}
  .label{font-size:13px; color:#c4d2e6}

  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    padding:10px 12px; border-radius:12px; border:1px solid #273449; background:#0e1420; color:#d8e6fb;
    font-size:15px; font-weight:700; cursor:pointer; touch-action:manipulation; user-select:none;
  }
  .chip.small{font-size:13px; padding:8px 10px}
  .chip.selected{background:var(--accent); border-color:transparent; color:#fff; box-shadow:0 6px 18px rgba(59,130,246,.25)}

  .rowGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:390px){ .rowGrid{grid-template-columns:1fr 1fr} }

  .modeSwitch{display:flex; gap:8px}
  .modeSwitch .chip{flex:1; text-align:center}

  /* blocchi condizionali */
  .hidden{display:none}

  /* Barra START (solo in settings) */
  .startBar{
    position:relative;
    padding: 10px 12px calc(12px + env(safe-area-inset-bottom));
    background:linear-gradient(180deg, rgba(10,16,24,0), rgba(10,16,24,.65));
    display:flex; gap:10px; align-items:center; justify-content:center;
  }
  .btn{
    flex:1; max-width:420px;
    padding:16px 18px; border:none; border-radius:14px; font-size:18px; font-weight:900;
    color:#fff; background:var(--accent); cursor:pointer; touch-action:manipulation;
    box-shadow:0 10px 28px rgba(59,130,246,.35);
  }

  /* ============ RUN VIEW (schermo pieno) ============ */
  .runView{position:relative; background:#000; display:none}
  .runView.on{display:block}

  .stage{position:absolute; inset:0; display:grid; place-items:center; transition:background-color .18s ease}
  .phaseBar{
    position:absolute; top:calc(8px + env(safe-area-inset-top)); left:0; right:0;
    display:flex; justify-content:center; padding:0 10px; pointer-events:none;
  }
  .phaseText{
    pointer-events:auto; font-size:clamp(13px,4.2vw,18px); text-transform:uppercase; line-height:1.2;
    color:#dbe9ff; background:rgba(10,16,24,.6);
    padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); max-width:96vw; word-break:break-word;
  }
  .setTag{
    position:absolute; left:10px; top:calc(8px + env(safe-area-inset-top));
    font-size:12px; color:#b0c4de; background:rgba(10,16,24,.55); padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.06)
  }

  .center{ text-align:center; padding:24px }
  .big{
    font-weight:900; line-height:1; margin:.05em 0;
    font-size:clamp(72px, 28dvh, 240px);
    color:#fff; letter-spacing:.02em;
    text-shadow: 0 0 8px rgba(0,0,0,.65), 0 0 24px rgba(0,0,0,.45),
      -2px -2px 0 rgba(0,0,0,.85), 2px -2px 0 rgba(0,0,0,.85),
      -2px 2px 0 rgba(0,0,0,.85), 2px 2px 0 rgba(0,0,0,.85);
  }
  .big.word{
    font-size: clamp(36px, 12dvh, 96px);
    line-height:1.05; max-width:96vw; word-break:break-word; padding:0 2vw;
  }
  .timer{
    font-size:clamp(14px,3.5vw,22px); color:#e9f3ff; background:rgba(10,16,24,.45);
    padding:.4em .7em; border-radius:12px; border:1px solid rgba(255,255,255,.06); display:inline-block;
  }
  .flash{ position:absolute; inset:0; pointer-events:none; box-shadow:0 0 0 0 rgba(255,255,255,0); }
  .flash.on{ animation:edge 240ms ease-out; }
  @keyframes edge{
    0%{ box-shadow: inset 0 0 0 6px rgba(255,255,255,.85), 0 0 20px rgba(255,255,255,.25); }
    100%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0), 0 0 0 rgba(255,255,255,0); }
  }

  /* Barra comandi in basso durante RUN */
  .runBar{
    position:fixed; left:0; right:0; bottom:0; z-index:5;
    padding: max(8px, env(safe-area-inset-bottom)) 10px calc(12px + env(safe-area-inset-bottom));
    display:flex; gap:10px; justify-content:center; align-items:center;
    background:linear-gradient(180deg, rgba(10,16,24,0), rgba(10,16,24,.65));
  }
  .bb{ flex:1; max-width:280px; padding:14px 16px; border:none; border-radius:14px; font-size:18px; font-weight:800; color:#fff; cursor:pointer; touch-action:manipulation; }
  .bb.primary{ background:var(--accent) }
  .bb.danger{ background:var(--danger) }

  /* Utility */
  .sr{position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px)}
</style>
</head>
<body>
  <div class="app">

    <!-- SETTINGS (nessun header, niente scroll) -->
    <section id="settings" class="settingsView">
      <div>
        <div class="heading">Imposta allenamento</div>
        <div class="sub">Scegli parametri e premi Start. Nessuno scroll, tutto a portata di pollice.</div>
      </div>

      <div class="row">
        <div class="label">Modalità</div>
        <div class="modeSwitch">
          <button class="chip selected" data-group="mode" data-value="color">Colori</button>
          <button class="chip" data-group="mode" data-value="number">Numeri</button>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Lavoro (s)</div>
          <div class="chips" id="workChips">
            <button class="chip selected" data-group="work" data-value="30">30</button>
            <button class="chip" data-group="work" data-value="20">20</button>
            <button class="chip" data-group="work" data-value="45">45</button>
            <button class="chip" data-group="work" data-value="60">60</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Pausa (s)</div>
          <div class="chips" id="restChips">
            <button class="chip" data-group="rest" data-value="0">0</button>
            <button class="chip selected" data-group="rest" data-value="15">15</button>
            <button class="chip" data-group="rest" data-value="20">20</button>
            <button class="chip" data-group="rest" data-value="30">30</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Set</div>
          <div class="chips">
            <button class="chip" data-group="sets" data-value="3">3</button>
            <button class="chip selected" data-group="sets" data-value="5">5</button>
            <button class="chip" data-group="sets" data-value="8">8</button>
            <button class="chip" data-group="sets" data-value="10">10</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Intervallo segnali (s)</div>
          <div class="chips">
            <button class="chip" data-group="interval" data-value="1">1.0</button>
            <button class="chip selected" data-group="interval" data-value="2">2.0</button>
            <button class="chip" data-group="interval" data-value="3">3.0</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Countdown</div>
          <div class="chips">
            <button class="chip" data-group="countdown" data-value="0">Off</button>
            <button class="chip selected" data-group="countdown" data-value="3">3</button>
            <button class="chip" data-group="countdown" data-value="5">5</button>
          </div>
        </div>

        <div class="row" id="colorCountRow">
          <div class="label">Quanti coni</div>
          <div class="chips">
            <button class="chip" data-group="count" data-value="3">3</button>
            <button class="chip selected" data-group="count" data-value="5">5</button>
            <button class="chip" data-group="count" data-value="6">6</button>
          </div>
        </div>
        <div class="row hidden" id="numberCountRow">
          <div class="label">Quanti numeri</div>
          <div class="chips">
            <button class="chip" data-group="count" data-value="3">3</button>
            <button class="chip selected" data-group="count" data-value="5">5</button>
            <button class="chip" data-group="count" data-value="8">8</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">Opzioni</div>
        <div class="chips">
          <button class="chip small selected" data-group="beep" data-value="on">Suono ON</button>
          <button class="chip small" data-group="beep" data-value="off">Suono OFF</button>
          <button class="chip small" data-group="tts" data-value="on">Voce ON</button>
          <button class="chip small selected" data-group="tts" data-value="off">Voce OFF</button>
        </div>
      </div>
    </section>

    <!-- START BUTTON (settings) -->
    <div class="startBar" id="startBar">
      <button id="startBtn" class="btn">START</button>
    </div>

    <!-- RUN VIEW -->
    <section id="run" class="runView">
      <div class="stage" id="stage">
        <div class="flash" id="flash"></div>
        <div class="setTag" id="setInfo">Set —</div>
        <div class="phaseBar"><div class="phaseText" id="phaseLabel">PRONTO</div></div>

        <div class="center" id="hitArea">
          <div class="big" id="mainLabel">—</div>
          <div class="timer"><span id="timeLeft">0.0</span> s</div>
        </div>
      </div>

      <div class="runBar">
        <button id="bbToggle" class="bb primary">Pausa</button>
        <button id="bbStop" class="bb danger" title="Tieni premuto per fermare">Stop</button>
      </div>
    </section>

  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const qs = (sel,root=document)=>root.querySelector(sel);
  const qsa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  const els = {
    // settings
    settings: $('settings'), startBar: $('startBar'), startBtn: $('startBtn'),
    colorCountRow: $('colorCountRow'), numberCountRow: $('numberCountRow'),
    // run
    run: $('run'), stage: $('stage'), flash: $('flash'),
    setInfo: $('setInfo'), phaseLabel: $('phaseLabel'), mainLabel: $('mainLabel'), timeLeft: $('timeLeft'),
    bbToggle: $('bbToggle'), bbStop: $('bbStop'), hitArea: $('hitArea'),
  };

  const defaultPalette = ['#ff3b30','#ffcc00','#34c759','#007aff','#af52de','#ff9f0a'];

  let app = {
    running:false, paused:false, phase:'idle',
    mode:'color', workMs:30000, restMs:15000, sets:5, intervalMs:2000, countdownMs:3000,
    count:5, colors:defaultPalette.slice(0,5), numbers:5,
    currentIdx:-1, setIndex:0, totalSets:5,
    startTs:0, phaseEndTs:0, nextSignalTs:0, pauseTs:0,
    rafId:null, audioCtx:null, lastSpoken:-1,
    beep:true, tts:false
  };

  /* =============== UI: Chips =============== */
  function selectInGroup(group, value){
    qsa(`.chip[data-group="${group}"]`).forEach(b=>{
      b.classList.toggle('selected', b.dataset.value===String(value));
    });
  }
  function readSettings(){
    const mode = qs('.chip[data-group="mode"].selected').dataset.value; // color|number
    const work = Number(qs('.chip[data-group="work"].selected').dataset.value)*1000;
    const rest = Number(qs('.chip[data-group="rest"].selected').dataset.value)*1000;
    const sets = Number(qs('.chip[data-group="sets"].selected').dataset.value);
    const interval = Number(qs('.chip[data-group="interval"].selected').dataset.value)*1000;
    const countdown = Number(qs('.chip[data-group="countdown"].selected').dataset.value)*1000;
    const count = Number(qs('.chip[data-group="count"].selected').dataset.value);
    const beep = qs('.chip[data-group="beep"].selected').dataset.value==='on';
    const tts  = qs('.chip[data-group="tts"].selected').dataset.value==='on';

    return {mode, work, rest, sets, interval, countdown, count, beep, tts};
  }
  function bindChips(){
    qsa('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const group = btn.dataset.group;
        // single-select groups
        const single = ['mode','work','rest','sets','interval','countdown','count','beep','tts'];
        if(single.includes(group)){
          qsa(`.chip[data-group="${group}"]`).forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
        }
        // toggle rows Color/Number
        if(group==='mode'){
          const mode = btn.dataset.value;
          els.colorCountRow.classList.toggle('hidden', mode!=='color');
          els.numberCountRow.classList.toggle('hidden', mode!=='number');
          // keep current count selection (use first selected in visible row)
          const visibleRow = mode==='color' ? els.colorCountRow : els.numberCountRow;
          const sel = qs('.chip.selected', visibleRow) || qs('.chip', visibleRow);
          const val = sel.dataset.value;
          // sync "count" group globally
          qsa('.chip[data-group="count"]').forEach(c=>c.classList.toggle('selected', c.dataset.value===val));
        }
      }, {passive:true});
    });
  }

  /* =============== Helpers =============== */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const fmtSec=(ms)=> (Math.ceil(ms/100)/10).toFixed(1);
  function setBg(c){ els.stage.style.background=c; }
  function setPhase(p){ app.phase=p; els.phaseLabel.textContent = p.toUpperCase(); }
  function setMainLabel(t){
    const s=String(t); const isNum = /^#?\d+$/.test(s);
    els.mainLabel.classList.toggle('word', !isNum);
    els.mainLabel.textContent=s;
  }
  function setTimeLeft(ms){ els.timeLeft.textContent=fmtSec(ms); }
  function setSetInfo(){ els.setInfo.textContent = `Set ${app.setIndex+1} di ${app.totalSets}`; }
  function chooseNextIndex(pool){ if(pool<=1) return 0; let i; do{i=Math.floor(Math.random()*pool);}while(i===app.currentIdx); return (app.currentIdx=i); }
  function flashEdge(){ els.flash.classList.remove('on'); void els.flash.offsetWidth; els.flash.classList.add('on'); }

  /* =============== Audio / Voce =============== */
  function beep(freq=880, dur=0.08, type='sine'){
    if(!app.beep) return;
    try{
      if(!app.audioCtx){ app.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      const ctx=app.audioCtx, o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
      o.start(); o.stop(ctx.currentTime + dur);
    }catch(e){}
  }
  function speakNumber(n){
    if(!app.tts) return;
    try{
      const u=new SpeechSynthesisUtterance(String(n));
      u.lang='it-IT'; u.rate=1.0; u.pitch=1.0;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }catch(e){}
  }

  /* =============== Flow =============== */
  function enterRun(){
    // hide settings, show run
    $('settings').style.display='none';
    $('startBar').style.display='none';
    els.run.classList.add('on');
  }
  function exitRun(){
    els.run.classList.remove('on');
    $('settings').style.display='grid';
    $('startBar').style.display='flex';
  }
  function resetUI(){
    setPhase('pronto'); setMainLabel('—'); setTimeLeft(0);
    setBg('#0a0f16'); els.setInfo.textContent='Set —'; app.lastSpoken=-1;
  }

  function start(){
    if(app.running) return;
    const cfg = readSettings();

    // prepare state
    const count = cfg.count;
    const colors = defaultPalette.slice(0, clamp(count,1,defaultPalette.length));
    app = {...app,
      running:true, paused:false, phase:(cfg.countdown>0?'countdown':'work'),
      mode:cfg.mode, setIndex:0, totalSets:cfg.sets,
      workMs:cfg.work, restMs:cfg.rest, intervalMs:cfg.interval, countdownMs:cfg.countdown,
      count:count, colors:colors, numbers:count, currentIdx:-1,
      beep:cfg.beep, tts:cfg.tts,
      startTs:performance.now()
    };
    app.phaseEndTs = app.startTs + (app.countdownMs>0?app.countdownMs:app.workMs);
    app.nextSignalTs = (app.countdownMs>0?0:app.startTs);

    setSetInfo(); setPhase(app.phase); setMainLabel(app.phase==='countdown'?'PARTENZA':'VAI!');
    setTimeLeft(app.countdownMs>0?app.countdownMs:app.workMs);
    setBg('#0a0f16');

    els.bbToggle.textContent='Pausa';
    enterRun();
    beep(660,0.12,'triangle');
    app.rafId = requestAnimationFrame(loop);
  }

  function pause(){
    if(!app.running || app.paused) return;
    app.paused=true; app.pauseTs=performance.now();
    cancelAnimationFrame(app.rafId); setMainLabel('PAUSA');
    els.bbToggle.textContent='Riprendi';
  }
  function resume(){
    if(!app.running || !app.paused) return;
    const now=performance.now(); const paused = now - app.pauseTs;
    app.phaseEndTs += paused; if(app.nextSignalTs) app.nextSignalTs += paused;
    app.paused=false; els.bbToggle.textContent='Pausa';
    app.rafId = requestAnimationFrame(loop);
  }
  function stop(){
    app.running=false; app.paused=false; cancelAnimationFrame(app.rafId);
    resetUI(); exitRun();
  }

  function nextPhase(){
    const now=performance.now();
    if(app.phase==='countdown'){
      setPhase('work'); setMainLabel('VAI!');
      app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square'); return;
    }
    if(app.phase==='work'){
      if(app.restMs>0){
        setPhase('rest'); setMainLabel('RECUPERO'); setBg('#0a0f16');
        app.startTs=now; app.phaseEndTs=now+app.restMs; app.nextSignalTs=0; beep(520,0.12,'sine');
      } else {
        if(app.setIndex+1>=app.totalSets) return finish();
        app.setIndex++; setSetInfo(); setPhase('work'); setMainLabel('VAI!');
        app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square');
      }
      return;
    }
    if(app.phase==='rest'){
      if(app.setIndex+1>=app.totalSets) return finish();
      app.setIndex++; setSetInfo(); setPhase('work'); setMainLabel('VAI!');
      app.startTs=now; app.phaseEndTs=now+app.workMs; app.nextSignalTs=now; beep(880,0.12,'square');
    }
  }
  function finish(){
    setPhase('fine'); setMainLabel('FINE ✅'); setBg('#0a0f16'); setTimeLeft(0);
    beep(440,0.1,'sine'); setTimeout(()=>beep(660,0.1,'sine'),120); setTimeout(()=>beep(880,0.1,'sine'),240);
    app.running=false; cancelAnimationFrame(app.rafId);
    // torna ai settings dopo 1s
    setTimeout(stop, 800);
  }

  function loop(){
    if(!app.running) return;
    const now=performance.now();
    if(app.paused){ app.rafId = requestAnimationFrame(loop); return; }

    const msLeft=Math.max(0, app.phaseEndTs-now);
    setTimeLeft(msLeft);

    if(app.phase==='work' && now>=app.nextSignalTs){
      if(app.mode==='color'){
        const idx=chooseNextIndex(app.colors.length);
        const c=app.colors[idx]; setBg(c); setMainLabel(`#${idx+1}`); app.lastSpoken=-1;
      } else {
        const idx=chooseNextIndex(app.numbers);
        const shown=idx+1; setBg('#0a0f16'); setMainLabel(String(shown));
        if(app.tts && shown!==app.lastSpoken){ speakNumber(shown); app.lastSpoken=shown; }
      }
      flashEdge();
      beep(1200,0.05,'square'); setTimeout(()=>beep(900,0.05,'square'),60);
      app.nextSignalTs = now + app.intervalMs;
    }

    if(msLeft<=0) nextPhase();
    app.rafId = requestAnimationFrame(loop);
  }

  /* =============== Events =============== */
  bindChips();

  // Start
  els.startBtn.addEventListener('click', start, {passive:true});

  // Run bar
  els.bbToggle.addEventListener('click', ()=>{ if(!app.running) return; if(app.paused) resume(); else pause(); }, {passive:true});

  // Stop con pressione prolungata
  let hold=null;
  const startHold=()=>{ hold=setTimeout(stop,800); };
  const endHold=()=>{ clearTimeout(hold); hold=null; };
  els.bbStop.addEventListener('touchstart', startHold, {passive:true});
  els.bbStop.addEventListener('mousedown', startHold);
  ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>els.bbStop.addEventListener(ev, endHold, {passive:true}));

  // Tap al centro = pausa/riprendi
  els.hitArea.addEventListener('click', ()=>{ if(!app.running) return; if(app.paused) resume(); else pause(); }, {passive:true});

  // Preselezione modalità sincronizza righe count
  (function initModeRows(){
    const modeSel = qs('.chip[data-group="mode"].selected').dataset.value;
    els.colorCountRow.classList.toggle('hidden', modeSel!=='color');
    els.numberCountRow.classList.toggle('hidden', modeSel!=='number');
  })();

})();
</script>

<!-- SW register (se usi il service worker versione con cache) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js?v=3').catch(()=>{});
  });
}
</script>
</body>
</html>
